---
import BaseLayout from "@layouts/BaseLayout.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "@consts";
import styles from '@styles/buy-ebook.module.scss';

const pageTitle = "Buy Ebook";
const pageDescription = "Purchase our amazing ebook on digital marketing for realtors.";
const stripePublishableKey = import.meta.env.PUBLIC_STRIPE_PUBLISHABLE_KEY;
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <div class={styles.container}>
    <h1 class={styles.title}>Buy My Ebook</h1>
    <button id="checkout-button" class={styles.purchaseButton}>Purchase</button>
  </div>
</BaseLayout>

<!-- Load Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>

<script is:inline define:vars={{ stripePublishableKey }}>
  document.addEventListener('DOMContentLoaded', (event) => {
    if (typeof Stripe === 'undefined') {
      console.error('Stripe.js not loaded');
      return;
    }

    const stripe = Stripe(stripePublishableKey);
    const checkoutButton = document.getElementById('checkout-button');

    if (checkoutButton) {
      checkoutButton.addEventListener('click', async () => {
        try {
          const response = await fetch('/api/create-checkout-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ebookTitle: 'The Real Estate Agent Digital Presence A-Z Guide', price: 9.99 })
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const { id } = await response.json();
          
          const result = await stripe.redirectToCheckout({
            sessionId: id
          });

          if (result.error) {
            console.error(result.error.message);
          }
        } catch (error) {
          console.error('Checkout error:', error);
        }
      });
    } else {
      console.error('Checkout button not found');
    }
  });
</script>