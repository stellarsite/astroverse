---
import BaseLayout from "@layouts/BaseLayout.astro";

const pageTitle = "Buy Ebook";
const pageDescription = "Purchase our amazing ebook on digital marketing for realtors.";
const stripePublishableKey = import.meta.env.PUBLIC_STRIPE_PUBLISHABLE_KEY;
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <main id="content">
    <div class="text-center py-10 px-4 sm:px-6 lg:px-8">
      <h1 class="block font-archivo-black uppercase text-4xl font-bold text-black sm:text-6xl dark:text-white mb-20">Buy The Ebook</h1>
      
      <form id="purchase-form" class="mb-6">
        <div class="mb-4">
          <input 
            type="email" 
            id="email-input" 
            required 
            placeholder="Enter your email" 
            class="w-full px-3 py-2 text-sm leading-tight text-gray-700 border rounded shadow appearance-none focus:outline-none focus:shadow-outline"
          />
        </div>
        <div class="mb-4">
          <label class="inline-flex items-center">
            <input type="checkbox" id="newsletter-checkbox" class="form-checkbox">
            <span class="ml-2">Sign up for our newsletter</span>
          </label>
        </div>
        <button 
          id="checkout-button" 
          type="submit"
          class="w-full sm:w-auto py-3 px-4 inline-flex justify-center items-center gap-x-2 text-sm font-semibold rounded-lg border border-transparent bg-neutral-400 text-white hover:bg-neutral-600 disabled:opacity-50 disabled:pointer-events-none"
        >
          Purchase
        </button>
      </form>
    </div>
  </main>
</BaseLayout>

<!-- Load Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>

<script is:inline define:vars={{ stripePublishableKey }}>
  document.addEventListener('DOMContentLoaded', (event) => {
    if (typeof Stripe === 'undefined') {
      console.error('Stripe.js not loaded');
      return;
    }

    const stripe = Stripe(stripePublishableKey);
    const purchaseForm = document.getElementById('purchase-form');
    const emailInput = document.getElementById('email-input');
    const newsletterCheckbox = document.getElementById('newsletter-checkbox');

    if (purchaseForm && emailInput && newsletterCheckbox) {
      purchaseForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const email = emailInput.value;
        const subscribeToNewsletter = newsletterCheckbox.checked;

        try {
          // First, create the checkout session
          const checkoutResponse = await fetch('/api/create-checkout-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              ebookTitle: 'The Real Estate Agent Digital Presence A-Z Guide', 
              price: 9.99,
              customerEmail: email
            })
          });
          
          if (!checkoutResponse.ok) {
            throw new Error(`HTTP error! status: ${checkoutResponse.status}`);
          }
          
          const { id: sessionId } = await checkoutResponse.json();

          // If user wants to subscribe to the newsletter, make the API call
          if (subscribeToNewsletter) {
            const subscribeResponse = await fetch('/api/subscribe', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email })
            });

            if (!subscribeResponse.ok) {
              console.error('Failed to subscribe to newsletter');
            }
          }

          // Redirect to Stripe Checkout
          const result = await stripe.redirectToCheckout({ sessionId });

          if (result.error) {
            console.error(result.error.message);
          }
        } catch (error) {
          console.error('Checkout error:', error);
        }
      });
    } else {
      console.error('One or more form elements not found');
    }
  });
</script>